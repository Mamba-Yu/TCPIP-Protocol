# TCPIP协议栈介绍

## 概述

一个精简的、小型化的具备主机模型的TCP/IP协议栈和安全功能的软件平台。

提供业界标准和根据产品需要定制的TCP/IP协议组件，构成一个完整的、产品可直接进行IP相关业务开发的平台。

为产品构建了设备结点间的通用的IP传输通道（链路层、网络层、传输层和应用层）。

Driver -> OS -> VOS/DOPRA -> TCPIP -> Pruduct APP

### 平台功能和特点

- **小型化和可裁减性**

采用组件化设计，减少了模块间的紧耦合关系，代码量少，LIB库大小500K左右

部分组件（如ACL、BFD、PTP）支持单独的通过CBB的形式向产品发布

- #### 良好的可移植性

调用底层操作系统的API是采用VOS封装的接口，并注册多类型CPU编程规范

支持多类型CPU，包括MOTO PowerPC、X86、ARM、MIPS等系列芯片

支持多种操作系统，包括Vxworks、Win32 、Linux等

内部的通讯相关的数据结构为了保证可移植性，都采取了4字节对齐

- #### 良好的可扩展性

提供预配置和注册钩子函数的方式，实现了具有通用性的定制特性，以满足用户各种特殊应用场景的需求

大部分协议处理组件（如UDP、IP）都提供了钩子函数的组件接口，方便用户对报文进行预处理、过滤和统计等

- #### 易用性

提供标准的Socket API，便于用户更方便的二次开发Socket应用程序和移植原有的Socket应用程序

仅需要链接LIB库文件和编译链接一个通用适配文件，并在初始化流程中调用InitTCPIPStack，就可以完成初始化的全过程。

#### 可维护性

- 提供统一的信息、告警、日志、调试的输出接口，便于产品注册到自己的信息中心进行输出
- 采用二进制日志方式，尽可能减少日志信息的存储空间
- 提供了各种协议报文统计信息的获取和查询接口

- 提供了各种协议报文的跟踪功能
- 提供了关键的动态运行信息（如状态机、重要表项）的查询接口
- 调试和日志信息分级控制和管理，便于用户进行信息过滤

#### 高性能

- 采用Mbuf Cache机制，减少了报文存储空间的内存申请和释放耗时，提升了10％的报文处理性能（包括时延和吞吐量）
- 采用协议报文首部缓存技术，在上层业务比较稳定的情况下，避免了各层协议的报文封装、解封装和查表处理，提升了至少20％的报文处理性能

## 在组网中的应用

- 在无线WCDMA网络中应用

  > 在无线NodeB基站中，主要完成用户数据的转发，控制数据的终结以及不同基站级联数据的转发
  >
  > 无线RNC基站控制器中，主要完成控制面的报文协商处理以及表项信息下发至NP，再由微码完成数据的转发
  >
  > NodeB与NodeB之间、NodeB与RNC之间、NodeB和路由器之间以及RNC与路由器之间可以通过以太网（ETH）或点对点（PPP）进行网络连接

- 在光网络中的组网

> ​	在光网络普通网元和网关网元中，主要用于PPP链路协商、控制报文（如OSPF）的传递以及维护报文（如FTP）的终结。DOPRA IP不承载产品实际的业务数据报文。
>
> 网关网元指的是与网关相连的光网络设备，两者之间通过以太网络（ETH）互联，网关网元与普通网元之间、普通网关与普通网关之间通过点对点（PPP）进行网络连接

总体架构

公共子系统：mbuf、ha、np、算法cbb

IPv4子系统：Socket4、TCP4、UDP4、RawIP4、ICMP4、IGMP4、SFIB4、AM4、PP4、VRF

IPv6子系统：Socket6、TCP6、UDP6、RawIP6、ICMP6、PMTU、SFIB6、ND、AM6、PP6

网络接口子系统：IFNET、ETHARP、PPP、MP、Trunk、POES、POEC、VLAN、ARPGUARD

应用子系统：Ping、Trrt、DNSC、DHCP4C、DHCP4R、DHCP6R、BFD

路由子系统：RTM、VLINK、OSPF、RIP

## 架构优势

#### 分层分模块的架构设计

- 通过分层隔离了影响部件变化和不稳定的因素，增强了系统的稳定性
- 通过分模块实现模块与模块之间的弱耦合，提高了系统的可靠性。系统有多个模块组成，实现系统的可静态裁剪性
- 每个模块设计时采用面向对象的设计思想，实现对象的封装（组件化），统一通过API的形式向用户开放访问和操作接口

#### 支持NP架构和HA备份

- 通过PPI接口（Product PlatForm  Interface），IP将控制面协商（如PPP协商、动态ARP学习）或配置（如配置静态路由、配置静态ARP）得到的信息，下发到微码，协助微码完成报文的转发，从而提升报文的转发处理性能。
- 借助产品的HA备份通道和HA主备仲裁机制，IP将主板的协议栈的相关数据备份到备板，并提供数据校验，共同完成主备倒换、无损升级功能，从而提升产品的可靠性。

#### 采用互斥信号量方式对临界资源进行保护

采用互斥信号量对临界资源进行保护，确保能正常的运行于各种抢占式运行环境（如基于任务的优先级抢占、时间片轮转等），也可以运行于非抢占式运行环境。

- 由于采用的是互斥信号量，对于同一个信号量可以连续多次进行PV操作，并可以避免优先级反转，从而降低信号量死锁的可能性。
- 对于紧密关联模块（如IFNET、PPP、ETHARP、PP4、TCP4、Socket等）的临界资源，IP采用同一个互斥信号量进行保护，避免因多个信号量的嵌套使用产生死锁。
- 对于松耦合模块（如Ping、DNSC、DHCP4C、DHCP4R等）的临界资源，IP各模块采用独立的互斥信号量进行保护，从而提升并发处理效率。

#### 采用用户注册钩子函数方式实现产品定制特性

在各层各模块都提供的大量钩子函数的注册接口，用来丰富和满足产品的定制需求。

- 在各层报文处理的入口和出口（如网络层、链路层）提供了钩子函数的注册接口，产品可以通过注册这类接口完成报文的预处理功能，如NAT处理、IWF（Inter-Working  Forward）、性能测试等。
- 通过用户注册的钩子函数，IP可以将各主要模块状态变化同步通知到产品，如接口Up/Down信息、BFD检测到的链路状态信息、路由变化信息等。
- IP的可维可测信息（如查询、日志、告警、调试）输出也是通过用户注册的钩子函数来完成的，产品可以灵活的将这些信息输出到维护管理平面、调试台、写日志文件等。
- 其他产品定制特性处理也是通过调用用户注册的钩子函数来完成的。



#### IP与产品其他模块或子系统之间的交互关系

- 产品应用系统基于IP提供的API进行二次开发，实现上层业务。
- 由于IP内部会使用到操作系统提供的相关资源，如内存、定时器、消息、时间、信号量等，而IP目前是通过VOS函数调用的方式去访问和获取这些资源的，所以IP依赖于VOS（虚拟操作系统），来屏蔽底层不同操作系统的差异性。
- IP提供了TCP/IP协议栈除物理层（跟硬件关系紧密）之外其他各层的协议组件，它与底层驱动程序存在密切联系：IP通过调用产品注册的接口，完成链路层报文的下送和控制信息的下发；底层驱动程序通过调用IP提供的API，将从硬件上收到的报文和获取的控制信息上送到IP进行继续处理。
- 产品配置管理模块基于IP提供的配置API，实现对IP业务相关的配置和管理维护。



#### IP与外部的交互机制：

- 数据结构引用

  产品在include了IP提供的对外头文件之后，可以直接在代码中引用IP定义的对外数据结构（包括宏定义、枚举、结构、自定义函数指针类型等）。

- API调用

  产品在include了IP提供的对外头文件之后，可以通过调用IP提供的用户API，完成所需的功能，这是最常用也最基本的方式。除钩子函数注册类API、参数预配置API外和初始化IP协议栈API外，其他API只能在IP协议栈初始化成功后调用。若某组件被裁减，则调用该组件提供的API将返回失败。

- 钩子函数机制

  IP定义钩子函数的原型，并提供产品注册钩子函数的接口，在IP的某部分特定功能流程中会调用这个钩子函数（假如产品注册了钩子函数）。

  产品要做的事情就是自行实现钩子函数的内容，并使用IP的钩子函数注册接口完成注册。

  IP提供了很多函数钩子函数接口，这些接口很大程度上丰富了IP的应用场景和实现产品所需的定制特性。

- 信息显示

  IP提供了许多系统信息显示接口，例如内存占用情况、报文统计信息、关键表项和状态机信息等。产品使用这些功能时直接调用相应的API即可，但产品必须挂接钩子函数对结果信息进行自定义输出。

- 静态配置

  产品可以通过修改IP发布的tcpip_adapter.h中定义的组件注册宏，实现对组件的裁减；可以通过修改IP发布的tcpip_sock.h中的VRP_FD_SETSIZE宏修改系统支持的最大Socket数目。

- 预配置

  IP实现了大量的定制特性，大多数定制特性都是通过预配置来使能的（默认不使能），产品只需要在IP协议栈初始化之前，调用TCPIP_Set_PreConfigPara使能定制特性即可。

#### IP内部模块间的交互手段有两种：

- IP内部模块可直接通过API（或内部函数）方式，直接访问IP基础组件。
- IP内部模块必须通过组件调用方式，访问可裁减组件，以消除符号依赖，达到可裁减的目的。


#### 标准符合：

IPv4： RFC 950    ICMPv4: 1256     

IPv6:    RFC 2460    ND: 2461      AM6:2462        ICMPv6:2463

TCP： RFC 793 / RFC 879

UDP:   RFC 768

PPP:    RFC 1661





