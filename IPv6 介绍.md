# IPv6 介绍

## IPv4互联网面临挑战

- 需要更大的通信能力，使人们拥有更多有价值的服务和应用
- IPv4剩余可分配地址严重不足，影响互连网深化发展
- “尽力而为”服务，质量没有保证
- 网络安全保护能力有限，存在隐患
- 数字鸿沟扩大，互联网普及受阻
- 如何推陈出新，提供更有价值的服务，避免走入死胡同

## IPv6的优势

- 几乎无限的地址空间，由32位扩充到128位，彻底解决IPv4地址不足的问题
- 简化固定报文头，提高效率
- 灵活的扩展报头，协议易扩展
- 地址格式更具层次性，便于路由聚合 
- 无状态自动配置，实现即插即用
- 网络层的IPSec认证与加密，端到端安全   
- 新增流标记域，提供QoS保证
- 有效支持移动网络、实时通信，IPv6具备强大的自动配置能力

## IPv6地址介绍

### 地址长度为何是128位？

* 在计算机中，当数据能用2的指数次幂字长位的二进制数表示时，CPU对数值的处理效率最高
* IPv4地址对应的是32比特字长，就是因为当时的互联网上的主机CPU字长为32位
* 128位机正在成长中，若定为64位，在网络扩展性上显得不足，因此从处理效率和未来网络扩展性上考虑，将IPv6的地址长度定为128位是十分合适的
* 共有2的128次方幂个IPv6地址，可分配地址数有340,282,366,920,938,463,463,374,607,431,768,211,456个
* 若按土地面积分配，每平方厘米可获得2.2*1020个地址。地球上每一粒沙子都会有一个IP地址

### 地址结构

- **IPv6地址 **= **前缀** **+** **接口标识**

  > **前缀**：相当于IPv4地址中的网络ID
  >
  > **接口标识**：相当于IPv4地址中的主机ID
  >
  > **本地链路地址:**  FE80::5ED9 : 98FF:FECA:A298
  >
  > **全球单播地址**:  2001:A304:6101:0001 : *5ED9:98FF:FECA:A298*

- **接口ID如何生成**

  > **由IEEE EUI-64规范自动生成 ：**    ![img](file:///C:/Users/y30004926/AppData/Roaming/eSpace_Desktop/UserData/y30004926/imagefiles/E5F5FE19-3EF4-4D43-9CC9-A84EDA6B2FCF.png)

  > **设备随机生成：**目前Windows XP支持该方式

  > **手动配置：**人为指定接口ID

### 地址格式

- **首选格式**

> 用十六进制表示，如：FE08:….
>
> 4个数字一组(16bits)，中间用 “ : ” 隔开，如：2001:12FC:….
>
> 地址前缀长度用“/xx”来表示
>
> 例如：2001:0410:0000:0001:0000:0000:0000:45ff/64

- **压缩格式**

> 若以零开头可以省略，连续全零的组可用“::”表示，如：  1:2::ACDE:….
>
> 一个地址中::只能出现一次
>
> 地址前缀长度用“/xx”来表示
>
> 例如： 2001:410:0:1::45ff/64

- **内嵌IPv4地址的格式**

> IPv6地址的其它部分（不包括IPv4地址的部分）可以采用首选或者压缩格式
>
> IPv6地址中内嵌的IPv4地址采用IPv4的十进制表示方法
>
> 地址前缀长度用“/xx”来表示
>
> 例如：0:0:0:0:0:0:166.168.1.2/64

### 地址类型

- **单播地址 ：** 标识一个接口，目的为单播地址的报文会被送到被标识的接口

> **未指定地址：**
>
> > 全0，表示为 ::/128
> >
> > 仅用于接口没有分配地址时作为源地址
> >
> > 在重复地址检测中出现
> >
> > 含有未指定地址的包不会被转发
>
> **环回地址：**
>
> > 表示为 ::1/128，如同IPv4中的127.0.0.1
>
> **全球单播地址 GUA：** 
>
> > 全球路由前缀（n bits）+ 子网ID（m bits）+ 接口ID（128-n-m bits），其中前两部分形成了IPv6的前缀，目前已经分配的全球单播地址前缀都是以001开头的，分配范围有以下几个：
> >
> > - 2001::/16                           IPv6 Internet
> >
> > - 2002::/16                           6 to 4 隧道
> >
> > - 2003::/16---3EED::/16      未分配
> >
> > - 3FFE::/16                            6 bone
>
> **内嵌IPv4地址的IPv6地址：**
>
> > IPv4兼容IPv6 ：以96位0加上32位IPv4地址形成，用于IPv4兼容IPv6自动隧道
> >
> > IPv4映射IPv6 ：以80位0加上16位1，再加上32位IPv4地址形成，用于IPv4与IPv6的互通
>
> **链路本地地址 LLA：**
>
> > 只能在连接到同一本地链路的节点之间使用
> >
> > 前缀 FE80::/64（最高10位值为1111111010），接口ID（使用IEEE EUI-64生成）作为地址的低64比特
> >
> > 当一个节点启动IPv6协议栈时，启动时节点的每个接口会<u>*自动配置*</u>一个链路本地地址
>
> **唯一本地地址 ULA：**
>
> > 仅能在一个站点内使用，不是自动生成的，类似于IPv4中的私有地址
> >
> > 前48位总是固定（最高10位值为1111111011），紧跟连续38位0。在接口ID和48位特定前缀之间有16位子网ID字段，供机构在内部构建子网

- **组播地址 ：** 标识多个接口，目的为组播地址的报文会被送到被标识的所有接口

> **最高位前8位为1** (8 bits)
>
> **标志（Flgs）字段** (4 bits)
>
> > 最高位：必须为0
> >
> > T: 0: 表示永久的组播地址; 1: 表示非永久的组播地址
> >
> > P: 0: 表示非基于单播前缀的组播地址；1 :表示基于单播前缀的组播地址，此时T必须为1
> >
> > R: 0: 表示非内嵌RP的组播地址；1: 表示内嵌RP的组播地址，此时T，P必须为1
>
> **Scope字段** (4 bits)
>
> > 0001：本地接口范围，单个接口范围有效，仅用于Loopback
> >
> > 0010：本地链路范围
> >
> > 0100：本地管理范围，管理员配置的
> >
> > 0101：本地站点范围
> >
> > 1000：本地组织范围，属于同一个组织的多个站点范围
> >
> > 1110：全局范围
>
> **Group ID** (112 bits)
>
> > 建议仅使用最低32位组ID，将剩余的80位都置0。这样每个组ID都映射到一个唯一的以太网组播MAC地址
>
> **特殊组播地址**
>
> > FF01::1（节点本地范围组播地址）
> >
> > FF02::1（链路本地范围所有节点组播地址）
> >
> > FF01::2（节点本地范围所有路由器组播地址）
> >
> > FF02::2（链路本地范围所有路由器组播地址）
> >
> > FF05::2（站点本地范围所有路由器组播地址）
> >
> > Solicited-node(被请求节点组播地址) :  由前缀[**FF02::1:FF00:0/104**]和单播地址的最后24位组成，用于重复地址检测和节点用来获取相同本地链路上邻居节点的链路层地址
>
> **组播MAC地址**
>
> > MAC地址是0x3333-A-A-A-A，其中A-A-A-A是IPv6 组播地址的后32位的直接映射
> >
> > MAC地址 33-33-00-00-00-01，对应于链路本地范围所有节点多播地址 FF02::1
> >
> > MAC地址 33-33-FF-3F-2A-1C，对应于被请求节点地址 FF02::1:FF3F:2A1C

- **任播地址 ：** 标识多个接口，目的为任播地址的报文会被送到最近的一个被标识接口，最近节点是由路由协议来定义的。任播地址与单播地址使用同一个地址空间，即由路由器决定数据包是做任播转发还是单播转发。

### 地址层次

- 利于路由快速查找
- 借助路由聚合，有效缩短路由表长度
- 提高路由器报文转发效率

### 地址状态

IPv6地址是有状态的，需要经过冲突探测（DAD）确认地址不冲突后才可以使用，主要包含如下几个地址状态：

- Tentative：初始状态，地址不可用

- Duplicate：冲突状态，地址不可用

- OK：地址可用状态


## 4 IPv6报文结构

### 报文构成

- **基本报头（IPv6 Header）**

> 基本报头报含 8个字段，总长度为40个字节
>
> >  **版本（Version）** : <u>4 bits</u>
> >
> > **通信流类别（Traffic Class）** :<u>8 bits</u>， 表示IPv6数据报的类或优先级
> >
> > **流标签（Flow Label）** :<u>20 bits</u>，标识这个数据报属于源节点和目标节点之间的一个特定数据报序列，一般来说一个流可以通过源/目的IPv6地址和流标签来确定。
> >
> > **有效载荷长度（Payload Length）** :<u>16 bits</u>，紧跟IPv6报头的数据报（即扩展报头和上层协议数据单元）
> >
> > **下一个报头（Next Header）** :<u>8 bits</u>，紧跟在基本报头后面的第一个扩展报头（如果存在）的类型，或者上层协议数据单元中的协议类型
> >
> > **跳数限制（Hop Limit）** :<u>8 bits</u>，数据报所能经过的最大跳数。每经过一个路由器，该数值减去1，当该字段的值为0时，数据报将被丢弃
> >
> > **源地址（Source Address）** :<u>128 bits</u>
> >
> > **目的地址（Destination Address）** :<u>128 bits</u>

- **扩展报头（Extension Headers）**

> **RFC 2460中定义了6个 IPv6 扩展头：**
>
> > **逐跳选项报头(0)** ：该扩展头被每一跳处理，可报含多种选项，如路由器告警选项
> >
> > - **Next Header \  Hdr Ext Len (不包括8 bits的Next Header) \ Options**
> > - Options字段在逐跳、目的选项报头中使用，每个选项以类型-长度-值（TLV）的格式编码
> >
> > - 选项类型（Option Type）表示这个选项内容的类型，其实它也确定了相关节点对该选项的处理方法。
> > - 选项长度（Opt Data Len）表示选项中的字节数，选项长度不包括选项类型和选项长度字段。
> > - 选项数据（Option Data）指与该选项相关的特定数据
> >
> > > RFC2640 规定：在选项类型字段中，最高的两位表示当处理选项的节点不能识别选项的类型时：
> >
> > - 00：跳过这个选项
> > - 01：无声地丢弃数据包
> > - 10：丢弃数据包，不管数据包目标地址是否为一个多播地址，向发送方发出一个ICMPv6参数问题报文
> > - 11：丢弃数据包，且如果数据包目标地址不是一个多播地址，向发送方发出一个ICMPv6参数问题报文
> >
> > >  选项类型字段中的第3高位表示在通向目标的路径中，选项数据是否可以改变：
> >
> > - 1：选项数据可以改变
> >
> > - 0：选项数据不可以改变
> >
> > > **作用：**
> >
> > - 用于巨型载荷（载荷长度超过65535字节），类型 194，长度字段占32 bits
> > - 用于路由器提示，使路由器检查该选项的信息，而不是简单的转发出去
> > - 用于资源预留(RSVP)
> >
> > **目的选项报头(80)** ：目的地处理， 可报含多种选项，如Mobile IPv6的家乡地址选项
> >
> > - 出现在路由扩展头之前时，它会被路由头地址列表中的节点处理
> > - 出现在上层协议数据报文之前，它仅可以被最终目的地处理
> >
> > **路由报头(43)** ：指定源路由，IPv6源节点用来指定信息报到达目的地的路径上所必须经过的中间节点。 IPv6基本报头的目的地址不是分组的最终目的地址，而是路由扩展头中所列的第一个地址
> >
> > > **Next Header \  Hdr Ext Len (不包括8 bits的Next Header) \ Routing Type **
> >
> > - **Segments Left** ：到达最终目的地还需要经过多少个必须的中间节点
> > - **Type-specific data** ：RFC2460中只定义了Routing Type=0时，Type-specific data是指定要经过的中间节点的地址
> >
> > - 报文最终目的地是路由头中节点地址列表中的最后一个地址
> > - 每经过一个指定的节点，就将地址列表中的下一个地址提取出来，作为IPv6基本包头中的目的地址
> >
> > **分段报头(44)：** IP报文分片信息，只由目的地处理
> >
> > > **Next Header \  Reserved**
> >
> > - **Fragment Offset** ：段偏移量，指当前报文内容在原始报文中的偏移位置
> > - **Res** ：保留字段，发送初始化时设置为0，接收时忽略该字段
> > - **M** ：标志位，1 :后续还有分段报文，0 :当前报文就是最后一个分段报文
> > - **Identification** ：分段的ID
> >
> > **认证报头(51)：** IPSec用扩展头， 提供认证服务等功能，只由目的地处理
> >
> > **封装安全净载报头(50)：** IPSec用扩展头，只由目的地处理
>
> **扩展报头规约：**
>
> > 出现顺序必须按 逐跳、目的、路由、分段、认证、安全、目的、上层协议数据
> >
> > 除目的选项报头外，每种扩展报头只能出现一次
> >
> > 目的选项头最多出现2次，1次在路由报头之前，1次在上层协议数据报文之前，如果没有路由报头，则只能出现一次

- **上层协议数据单元 (Upper Layer Protocol Data Unit)**


